name: Release

on:
  push:
    branches: [main, beta, alpha]
  # 移除 workflow_dispatch 或根据需要保留

# 必须的权限配置
permissions:
  id-token: write # 用于 npm Trusted Publishing
  contents: write # 用于创建 Git tag 和 GitHub Release
  issues: write # 用于更新 issue 链接
  pull-requests: write # 用于更新 PR 链接

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 必须获取完整历史记录供 semantic-release 分析
          token: ${{ secrets.GITHUB_TOKEN }} # 用于推送回仓库

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org/'
          scope: '@planarcat'

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install

      - name: Build package
        run: pnpm run build

      - name: Verify build output
        run: |
          if [ ! -d "dist" ] || [ -z "$(ls -A dist/ 2>/dev/null)" ]; then
            echo "❌ 构建失败或 dist 目录为空"
            exit 1
          fi
          echo "✅ 构建产物检查通过"

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 确保 npm 版本足够新以支持 provenance
          npm install -g npm@latest
          # 执行 semantic-release
          npx semantic-release --debug
