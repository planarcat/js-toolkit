name: Publish to npm

# 只在标签推送时触发
on:
  push:
    tags: ['v*']
  # 允许手动触发
  workflow_dispatch:

# 配置权限，用于 Trusted Publishing
permissions:
  # 允许生成 OIDC 令牌用于 npm 身份验证
  id-token: write
  # 允许读取仓库内容和创建 GitHub Release
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # 确保获取完整的 git 历史
          fetch-depth: 0

      - name: Set up Node.js for Trusted Publishing
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org/'
          # 配置用于 Trusted Publishing 的设置
          scope: '@planarcat'

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install

      - name: Build package
        run: pnpm run build

      - name: Publish to npm with Trusted Publishing
        run: |
          # 详细调试信息
          echo "=== 调试信息 ==="
          echo "GitHub 仓库: ${{ github.repository }}"
          echo "GitHub 分支: ${{ github.ref }}"
          echo "GitHub 事件: ${{ github.event_name }}"
          echo "GitHub 运行 ID: ${{ github.run_id }}"
          echo "GitHub 工作流: ${{ github.workflow }}"

          echo "=== 环境信息 ==="
          echo "Node.js 版本: $(node -v)"
          echo "npm 版本: $(npm -v)"
          echo "pnpm 版本: $(pnpm -v)"
          echo "操作系统: ${{ runner.os }}"

          echo "=== 包配置 ==="
          echo "包名: $(node -p 'require("./package.json").name')"
          echo "包版本: $(node -p 'require("./package.json").version')"
          echo "包访问权限: $(node -p 'require("./package.json").publishConfig?.access || \"undefined\"')"

          echo "=== 目录结构 ==="
          echo "当前目录: $(pwd)"
          echo "根目录文件:"
          ls -la

          echo "=== 构建产物 ==="
          if [ -d dist ]; then
            echo "dist目录存在，内容:"
            ls -la dist/
          else
            echo "⚠️  dist目录不存在！"
            echo "构建命令输出:"
            pnpm run build
          fi

          echo "=== npm 配置 ==="
          npm config list

          echo "=== 发布前准备 ==="
          echo "发布版本: ${{ github.ref_name }}"
          echo "发布命令: npm publish --access public"

          echo "=== 开始发布 ==="
          # 使用 npm publish 直接发布，确保使用 OIDC 身份验证
          npm publish --access public
          # Trusted Publishing 会自动处理 OIDC 身份验证

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-beta') || contains(github.ref_name, '-alpha') }}
