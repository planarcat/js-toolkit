# 增加日期格式化编译模式

## 1. 设计思路

### 1.1 核心概念
- **编译模式**：首次调用时解析格式化字符串，生成高效的处理函数，后续调用直接使用缓存的函数
- **空间换时间**：通过缓存编译后的函数，减少重复解析和计算开销
- **向后兼容**：保持原有API不变，新增编译相关API

### 1.2 实现架构
```
┌───────────────────────────┐
│      formatDate API       │
└─────────┬─────────────────┘
          │
          ├───────────────┐
          │   检查缓存    │
          └───────────────┘
          │
┌─────────▼─────────────────┐
│    编译格式化字符串      │
└─────────┬─────────────────┘
          │
┌─────────▼─────────────────┐
│   生成处理函数并缓存      │
└─────────┬─────────────────┘
          │
┌─────────▼─────────────────┐
│     执行处理函数          │
└─────────┬─────────────────┘
          │
┌─────────▼─────────────────┐
│     返回格式化结果        │
└───────────────────────────┘
```

## 2. 实现方案

### 2.1 缓存机制
- 创建全局缓存对象 `compiledFormatCache`
- 使用格式化字符串作为缓存键
- 实现LRU策略，限制最大缓存数量为100

### 2.2 编译函数
- 函数名：`compileDateFormatter`
- 参数：`formatStr: string`
- 返回：编译后的处理函数 `(date: Date, options: DateFormatOptions) => string`
- 实现：
  - 解析格式化字符串
  - 生成包含直接替换逻辑的函数代码
  - 使用 `new Function()` 生成函数
  - 避免使用 `eval`，提高安全性

### 2.3 核心优化点
- **减少字符串替换次数**：编译后的函数直接拼接结果，避免多次正则替换
- **预计算固定值**：在编译时计算固定的格式化逻辑
- **优化条件判断**：将复杂的替换逻辑转换为简单的属性访问

### 2.4 新增API
- `compileDateFormatter(formatStr: string): (date: Date, options?: DateFormatOptions) => string`：手动编译格式化字符串
- `clearDateFormatterCache(): void`：清除编译缓存
- `getDateFormatterCacheSize(): number`：获取缓存大小

### 2.5 向后兼容
- 保持原有 `formatDate` API不变
- 自动检测是否使用编译模式
- 支持自定义缓存配置

## 3. 实现步骤

### 3.1 步骤1：创建缓存管理模块
- 添加缓存对象和LRU管理逻辑
- 实现缓存清除和大小获取API

### 3.2 步骤2：实现编译函数
- 解析格式化字符串
- 生成处理函数代码
- 使用 `new Function()` 创建函数
- 处理各种格式化标记

### 3.3 步骤3：修改formatDate函数
- 添加缓存检查逻辑
- 支持编译模式
- 保持原有API不变

### 3.4 步骤4：更新类型定义
- 在 `src/types/date.ts` 中添加编译相关类型
- 更新现有类型定义

### 3.5 步骤5：编写测试用例
- 测试编译模式的正确性
- 测试缓存机制
- 测试性能提升
- 测试向后兼容性

### 3.6 步骤6：更新文档
- 更新README.md
- 更新函数JSDoc注释
- 添加编译模式使用示例

## 4. 预期性能提升

| 场景 | 预期提升倍数 |
|------|--------------|
| 简单格式（YYYY-MM-DD） | 3-5倍 |
| 复杂格式（YYYY-MM-DD HH:mm:ss SSS） | 8-15倍 |
| 极端复杂格式 | 20倍以上 |

## 5. 注意事项

### 5.1 安全考虑
- 避免使用 `eval`，使用 `new Function()`
- 对输入格式化字符串进行安全检查
- 限制缓存大小，防止内存泄漏

### 5.2 调试支持
- 生成的函数包含调试信息
- 支持源码映射
- 提供调试模式开关

### 5.3 边界情况处理
- 无效格式化字符串
- 空字符串
- 特殊字符
- 自定义格式化器

## 6. 文件变更

- `src/date/formatDate.ts`：修改核心函数，添加编译模式支持
- `src/date/compileDateFormatter.ts`：新增编译函数
- `src/types/date.ts`：更新类型定义
- `__tests__/unit/date/formatDate.test.ts`：新增测试用例
- `__tests__/unit/date/compileDateFormatter.test.ts`：新增测试用例
- `README.md`：更新文档

通过以上实现，我们将为日期格式化功能添加编译模式，显著提升性能，达到企业级性能要求，同时保持良好的向后兼容性和安全性。